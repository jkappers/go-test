name: Deploy to Docker Host

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: string
      image-tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
    secrets:
      DOCKER_HOST:
        required: true
      DOCKER_USER:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SSH_PORT:
        required: false
      GH_TOKEN:
        required: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: http://${{ vars.DOCKER_HOST }}:${{ vars.HOST_PORT }}
    permissions:
      contents: read

    steps:
      - name: Deploy to Docker Host via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ inputs.image-tag }}
          CONTAINER_NAME: ${{ vars.CONTAINER_NAME }}
          HOST_PORT: ${{ vars.HOST_PORT }}
          CONTAINER_PORT: ${{ vars.CONTAINER_PORT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.DOCKER_HOST }}
          username: ${{ secrets.DOCKER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          envs: IMAGE_TAG,CONTAINER_NAME,HOST_PORT,CONTAINER_PORT,GITHUB_REPOSITORY,GH_TOKEN,GH_ACTOR
          script: |
            # Login to GitHub Container Registry
            echo "$GH_TOKEN" | docker login ghcr.io -u "$GH_ACTOR" --password-stdin

            # Pull the new image
            echo "Pulling image: ${IMAGE_TAG}"
            docker pull ${IMAGE_TAG}

            # Stop and remove old container
            echo "Stopping old container: ${CONTAINER_NAME}"
            docker stop ${CONTAINER_NAME} || true
            docker rm ${CONTAINER_NAME} || true

            # Run new container
            echo "Starting new container: ${CONTAINER_NAME}"
            docker run -d \
              --name ${CONTAINER_NAME} \
              --restart unless-stopped \
              -p ${HOST_PORT}:${CONTAINER_PORT} \
              -e PORT=${CONTAINER_PORT} \
              ${IMAGE_TAG}

            # Wait for container to be healthy
            echo "Waiting for container to be healthy..."
            for i in {1..30}; do
              if docker inspect --format='{{.State.Health.Status}}' ${CONTAINER_NAME} | grep -q "healthy"; then
                echo "Container is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "Container failed to become healthy"
                docker logs ${CONTAINER_NAME}
                exit 1
              fi
              echo "Waiting... ($i/30)"
              sleep 2
            done

            # Cleanup old images (keep last 3)
            echo "Cleaning up old images..."
            docker images ghcr.io/${GITHUB_REPOSITORY} --format "{{.ID}} {{.CreatedAt}}" | \
              sort -rk 2 | \
              awk 'NR>3 {print $1}' | \
              xargs -r docker rmi || true

            echo "Deployment completed successfully!"

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Host**: ${{ vars.DOCKER_HOST }}:${{ vars.HOST_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container**: ${{ vars.CONTAINER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Check" >> $GITHUB_STEP_SUMMARY
          echo "Access the application at: http://${{ vars.DOCKER_HOST }}:${{ vars.HOST_PORT }}" >> $GITHUB_STEP_SUMMARY
