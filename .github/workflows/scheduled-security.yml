name: Scheduled Security Scan

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GO_VERSION: "1.25.4"

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  code-security:
    name: Code Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [main, staging]

    steps:
      - name: Checkout ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run gosec Security Scanner
        uses: securego/gosec@v2.21.4
        with:
          args: '-fmt sarif -out gosec-${{ matrix.branch }}.sarif ./...'
        continue-on-error: true

      - name: Upload gosec results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: gosec-${{ matrix.branch }}.sarif
          category: gosec-${{ matrix.branch }}

      - name: Run govulncheck
        id: govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... > vulncheck-${{ matrix.branch }}.txt 2>&1 || true

          if grep -q "Vulnerability" vulncheck-${{ matrix.branch }}.txt; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: vulncheck-${{ matrix.branch }}
          path: vulncheck-${{ matrix.branch }}.txt
          retention-days: 30

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag: [main, staging]

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists
        id: check
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"
          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image=$IMAGE" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image $IMAGE does not exist, skipping scan"
          fi

      - name: Run Trivy vulnerability scanner
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ steps.check.outputs.image }}
          format: 'sarif'
          output: 'trivy-${{ matrix.tag }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        if: steps.check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-${{ matrix.tag }}.sarif'
          category: trivy-${{ matrix.tag }}

      - name: Run Trivy (table format for logs)
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ steps.check.outputs.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [code-security, container-security]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
        continue-on-error: true

      - name: Create summary
        run: |
          echo "## Daily Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branches Scanned" >> $GITHUB_STEP_SUMMARY
          echo "- main" >> $GITHUB_STEP_SUMMARY
          echo "- staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
          echo "- gosec (Go security linter)" >> $GITHUB_STEP_SUMMARY
          echo "- govulncheck (Go vulnerability check)" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy (Container vulnerability scanner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "Check the Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for vulnerabilities in reports
          if ls reports/vulncheck-*/vulncheck-*.txt 1> /dev/null 2>&1; then
            echo "### Vulnerability Reports" >> $GITHUB_STEP_SUMMARY
            for report in reports/vulncheck-*/vulncheck-*.txt; do
              branch=$(basename "$report" .txt | sed 's/vulncheck-//')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### $branch" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -50 "$report" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            done
          fi
