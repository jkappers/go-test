name: Scheduled Security Scan

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOTNET_VERSION: "10.0.x"

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  code-security:
    name: Code Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [main, staging]

    steps:
      - name: Checkout ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Check for vulnerable packages
        id: vuln_check
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerable-${{ matrix.branch }}.txt
          if grep -q "has the following vulnerable packages" vulnerable-${{ matrix.branch }}.txt; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Install security-code-scan tool
        run: dotnet tool install --global security-scan --version 5.6.7

      - name: Run security code analysis
        run: |
          security-scan src/sample.csproj --verbose --export=security-${{ matrix.branch }}.sarif || true
        continue-on-error: true

      - name: Upload security results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: security-${{ matrix.branch }}.sarif
          category: security-code-scan-${{ matrix.branch }}
        continue-on-error: true

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerable-packages-${{ matrix.branch }}
          path: vulnerable-${{ matrix.branch }}.txt
          retention-days: 30

  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag: [main, staging]

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists
        id: check
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"
          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image=$IMAGE" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image $IMAGE does not exist, skipping scan"
          fi

      - name: Run Trivy vulnerability scanner
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ steps.check.outputs.image }}
          format: 'sarif'
          output: 'trivy-${{ matrix.tag }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        if: steps.check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-${{ matrix.tag }}.sarif'
          category: trivy-${{ matrix.tag }}

      - name: Run Trivy (table format for logs)
        if: steps.check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.29.0
        with:
          image-ref: ${{ steps.check.outputs.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [code-security, container-security]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports
        continue-on-error: true

      - name: Create summary
        run: |
          echo "## Daily Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branches Scanned" >> $GITHUB_STEP_SUMMARY
          echo "- main" >> $GITHUB_STEP_SUMMARY
          echo "- staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scans Performed" >> $GITHUB_STEP_SUMMARY
          echo "- dotnet list package --vulnerable (NuGet package vulnerability check)" >> $GITHUB_STEP_SUMMARY
          echo "- security-code-scan (.NET security analyzer)" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy (Container vulnerability scanner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "Check the Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for vulnerabilities in reports
          if ls reports/vulnerable-packages-*/vulnerable-*.txt 1> /dev/null 2>&1; then
            echo "### Vulnerability Reports" >> $GITHUB_STEP_SUMMARY
            for report in reports/vulnerable-packages-*/vulnerable-*.txt; do
              branch=$(basename "$report" .txt | sed 's/vulnerable-//')
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### $branch" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              head -50 "$report" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            done
          fi
