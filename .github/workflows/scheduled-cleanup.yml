name: Scheduled Cleanup

on:
  schedule:
    - cron: '0 3 * * 0'  # 3 AM UTC every Sunday
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not delete anything)'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write
  actions: write

jobs:
  cleanup-images:
    name: Cleanup Container Images
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image versions
        id: versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching container image versions..."

          # Get package versions
          PACKAGE_NAME=$(echo "${{ env.IMAGE_NAME }}" | cut -d'/' -f2)

          # Get all versions
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions" \
            --paginate > versions.json 2>/dev/null || echo "[]" > versions.json

          echo "versions_file=versions.json" >> $GITHUB_OUTPUT

      - name: Identify images to delete
        id: identify
        run: |
          # Calculate cutoff date (90 days ago)
          CUTOFF_DATE=$(date -d '90 days ago' '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || date -v-90d '+%Y-%m-%dT%H:%M:%SZ')
          echo "Cutoff date: $CUTOFF_DATE"

          # Protected tags (never delete)
          PROTECTED_PATTERNS="^(latest|main|staging|v[0-9]+\.[0-9]+\.[0-9]+.*)$"

          # Parse versions and identify candidates for deletion
          jq -r --arg cutoff "$CUTOFF_DATE" --arg protected "$PROTECTED_PATTERNS" '
            .[] |
            select(.updated_at < $cutoff) |
            select(
              (.metadata.container.tags | length == 0) or
              (.metadata.container.tags | all(test($protected) | not))
            ) |
            {id: .id, tags: .metadata.container.tags, updated: .updated_at}
          ' versions.json > to_delete.json

          DELETE_COUNT=$(jq -s 'length' to_delete.json)
          echo "Found $DELETE_COUNT images eligible for deletion"
          echo "delete_count=$DELETE_COUNT" >> $GITHUB_OUTPUT

          # Show what would be deleted
          echo "### Images to be deleted:" >> $GITHUB_STEP_SUMMARY
          if [ "$DELETE_COUNT" -gt 0 ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat to_delete.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No images eligible for deletion" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Delete old images
        if: steps.identify.outputs.delete_count > 0 && (github.event_name == 'schedule' || inputs.dry_run == false)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_NAME=$(echo "${{ env.IMAGE_NAME }}" | cut -d'/' -f2)
          DELETED=0
          FAILED=0

          while read -r version_id; do
            if [ -n "$version_id" ]; then
              echo "Deleting version: $version_id"
              if gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                "/users/${{ github.repository_owner }}/packages/container/${PACKAGE_NAME}/versions/${version_id}" 2>/dev/null; then
                DELETED=$((DELETED + 1))
              else
                FAILED=$((FAILED + 1))
              fi
            fi
          done < <(jq -r '.id' to_delete.json)

          echo "Deleted: $DELETED, Failed: $FAILED"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deletion Results" >> $GITHUB_STEP_SUMMARY
          echo "- Deleted: $DELETED images" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: $FAILED images" >> $GITHUB_STEP_SUMMARY

      - name: Dry run notice
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == true
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This was a dry run. No images were deleted." >> $GITHUB_STEP_SUMMARY
          echo "Run with 'dry_run: false' to actually delete images." >> $GITHUB_STEP_SUMMARY

  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Delete old workflow artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching workflow artifacts..."

          # Calculate cutoff date (90 days ago in seconds)
          CUTOFF_SECONDS=$((90 * 24 * 60 * 60))
          NOW_SECONDS=$(date +%s)

          DELETED=0
          FAILED=0

          # Get artifacts older than 90 days
          gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/artifacts" \
            --paginate \
            -q ".artifacts[] | select((.created_at | fromdateiso8601) < ($NOW_SECONDS - $CUTOFF_SECONDS) | tonumber) | .id" \
            2>/dev/null | while read -r artifact_id; do
            if [ -n "$artifact_id" ]; then
              echo "Deleting artifact: $artifact_id"

              if [ "${{ github.event_name }}" = "schedule" ] || [ "${{ inputs.dry_run }}" = "false" ]; then
                if gh api \
                  --method DELETE \
                  -H "Accept: application/vnd.github+json" \
                  "/repos/${{ github.repository }}/actions/artifacts/${artifact_id}" 2>/dev/null; then
                  DELETED=$((DELETED + 1))
                else
                  FAILED=$((FAILED + 1))
                fi
              else
                echo "Would delete (dry run): $artifact_id"
              fi
            fi
          done || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifact Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "Processed artifacts older than 90 days" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Cleanup Summary
    runs-on: ubuntu-latest
    needs: [cleanup-images, cleanup-artifacts]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Weekly Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cleanup Scope" >> $GITHUB_STEP_SUMMARY
          echo "- Container images older than 90 days (excluding protected tags)" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow artifacts older than 90 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Protected Tags (never deleted)" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`staging\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version tags (\`v*.*.*\`)" >> $GITHUB_STEP_SUMMARY
